---
import Layout from '../../layouts/Layout.astro';
import { readdir, readFile } from 'node:fs/promises';
import { join } from 'node:path';
import matter from 'gray-matter';
import Markdoc from '@markdoc/markdoc';

export async function getStaticPaths() {
  const peopleDir = join(process.cwd(), 'content/people');
  const files = await readdir(peopleDir).catch(() => []);
  
  return files
    .filter(file => file.endsWith('.mdoc'))
    .map(file => ({
      params: { slug: file.replace('.mdoc', '') }
    }));
}

const { slug } = Astro.params;

let person = null as null | {
  slug: string;
  name: string;
  role?: string;
  email?: string;
  avatar?: string;
  bioHtml?: string;
};

try {
  const filePath = join(process.cwd(), 'content/people', `${slug}.mdoc`);
  const raw = await readFile(filePath, 'utf-8');
  const { data, content } = matter(raw);
  const ast = Markdoc.parse(content);
  const transformed = Markdoc.transform(ast);
  const bioHtml = Markdoc.renderers.html(transformed);
  person = {
    slug,
    name: (data.name as string) ?? slug,
    role: (data.role as string) ?? '',
    email: (data.email as string) ?? '',
    avatar: (data.avatar as string) ?? '',
    bioHtml,
  };
} catch (e) {
  person = null;
}
---

<Layout title={person ? `${person.name} - Profile` : 'Person Not Found'}>
  <div class="container">
    {person ? (
      <article>
        <header style="display: flex; gap: 1.5rem; align-items: center; margin-bottom: 2rem;">
          {person.avatar && (
            <img src={person.avatar} alt={person.name} style="width: 140px; height: 140px; border-radius: 50%; object-fit: cover;" />
          )}
          <div>
            <h1 style="margin-bottom: 0.25rem;">{person.name}</h1>
            {person.role && <p class="role" style="color: #667eea; font-weight: 500;">{person.role}</p>}
            {person.email && (
              <p class="email"><a href={`mailto:${person.email}`}>{person.email}</a></p>
            )}
          </div>
        </header>

        {person.bioHtml && (
          <div class="bio" set:html={person.bioHtml} />
        )}
      </article>
    ) : (
      <div style="padding: 3rem 0;">
        <h2>Person not found</h2>
        <p>The requested profile does not exist.</p>
      </div>
    )}

    <div style="margin-top: 2rem;">
      <a href="/people" style="color: #667eea; text-decoration: none;">‚Üê Back to People</a>
    </div>
  </div>
</Layout>
